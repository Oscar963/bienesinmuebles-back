# üîí An√°lisis de Middleware que Protegen las Rutas

## üìã Resumen Ejecutivo

El sistema implementa una **arquitectura de seguridad en capas** con m√∫ltiples niveles de protecci√≥n:

1. **Autenticaci√≥n**: Laravel Sanctum para API
2. **Autorizaci√≥n por Roles**: Spatie Laravel Permission
3. **Autorizaci√≥n por Permisos**: Permisos granulares por m√≥dulo
4. **Validaci√≥n de Reglas de Negocio**: Middleware personalizados
5. **Protecci√≥n de Recursos**: Validaci√≥n de acceso a direcciones

## üèóÔ∏è Arquitectura de Seguridad

### 1. **Middleware Global (Kernel.php)**

```php
protected $middleware = [
    \App\Http\Middleware\TrustProxies::class,
    \Fruitcake\Cors\HandleCors::class,
    \App\Http\Middleware\PreventRequestsDuringMaintenance::class,
    \Illuminate\Foundation\Http\Middleware\ValidatePostSize::class,
    \App\Http\Middleware\TrimStrings::class,
    \Illuminate\Foundation\Http\Middleware\ConvertEmptyStringsToNull::class,
    \Illuminate\Session\Middleware\StartSession::class,
    \Illuminate\View\Middleware\ShareErrorsFromSession::class,
];
```

### 2. **Middleware de API**

```php
'api' => [
    \Laravel\Sanctum\Http\Middleware\EnsureFrontendRequestsAreStateful::class,
    'throttle:api',
    \Illuminate\Routing\Middleware\SubstituteBindings::class,
],
```

### 3. **Middleware de Rutas Registrados**

```php
protected $routeMiddleware = [
    'auth' => \App\Http\Middleware\Authenticate::class,
    'direction.permission' => \App\Http\Middleware\CheckDirectionPermission::class,
    'validate.hierarchical.user' => \App\Http\Middleware\ValidateHierarchicalUserDirection::class,
    'role' => \Spatie\Permission\Middlewares\RoleMiddleware::class,
    'permission' => \Spatie\Permission\Middlewares\PermissionMiddleware::class,
    'role_or_permission' => \Spatie\Permission\Middlewares\RoleOrPermissionMiddleware::class,
];
```

## üîê Niveles de Protecci√≥n

### **Nivel 1: Autenticaci√≥n**
```php
Route::middleware('auth:sanctum')->group(function () {
    // Todas las rutas protegidas requieren autenticaci√≥n
});
```

### **Nivel 2: Autorizaci√≥n por Roles**
```php
Route::middleware(['role:Administrador del Sistema|Administrador Municipal'])->group(function () {
    // Solo administradores pueden acceder
});
```

### **Nivel 3: Autorizaci√≥n por Permisos**
```php
Route::middleware(['permission:purchase_plans.list'])->group(function () {
    // Solo usuarios con permiso espec√≠fico
});
```

### **Nivel 4: Validaci√≥n de Reglas de Negocio**
```php
Route::middleware('validate.hierarchical.user')->group(function () {
    // Valida reglas espec√≠ficas del dominio
});
```

## üìã Resumen de Cambios Implementados

### ‚úÖ **Cambios Realizados**

1. **üîê Autenticaci√≥n y Autorizaci√≥n**
   - ‚úÖ Sistema de autenticaci√≥n con Sanctum
   - ‚úÖ Roles jer√°rquicos implementados
   - ‚úÖ Permisos granulares por m√≥dulo
   - ‚úÖ Middleware personalizado para validaci√≥n jer√°rquica

2. **üë• Gesti√≥n de Usuarios**
   - ‚úÖ Validaci√≥n de usuarios jer√°rquicos (una direcci√≥n)
   - ‚úÖ Administradores pueden tener m√∫ltiples direcciones
   - ‚úÖ Middleware `validate.hierarchical.user` implementado

3. **üè¢ Gesti√≥n de Direcciones**
   - ‚úÖ Relaciones director-direcci√≥n
   - ‚úÖ Asignaci√≥n de usuarios a direcciones
   - ‚úÖ Validaci√≥n de jerarqu√≠as

4. **üìä Planes de Compra**
   - ‚úÖ Validaci√≥n de planes √∫nicos por direcci√≥n/a√±o
   - ‚úÖ Estados y flujo de trabajo
   - ‚úÖ Historial de movimientos
   - ‚úÖ Exportaci√≥n de datos
   - ‚úÖ **Restricci√≥n de env√≠o: Solo Administrador del Sistema, Administrador Municipal y Director**

5. **‚öôÔ∏è Configuraci√≥n del Sistema**
   - ‚úÖ M√≥dulos de configuraci√≥n protegidos para administradores
   - ‚úÖ **M√≥dulos `type-projects`, `unit-purchasings`, `type-purchases`, `budget-allocations` y `status-item-purchases` accesibles para todos los usuarios autenticados**
   - ‚úÖ Gesti√≥n de estados y tipos

6. **üîç Auditor√≠a y Logs**
   - ‚úÖ Logs de actividad implementados
   - ‚úÖ Trazabilidad de cambios
   - ‚úÖ Historial de estados

7. **üß™ Testing**
   - ‚úÖ Tests de validaci√≥n de planes √∫nicos
   - ‚úÖ Tests de permisos y roles
   - ‚úÖ Tests de middleware personalizado
   - ‚úÖ **Comando para probar permisos de env√≠o de planes**

8. **üîÑ Migraci√≥n de Roles**
   - ‚úÖ **Cambio de "Secretar√≠a Comunal de Planificaci√≥n" ‚Üí "Encargado de Presupuestos"**
   - ‚úÖ **Cambio de "Subrogante de Secretar√≠a Comunal de Planificaci√≥n" ‚Üí "Subrogante de Encargado de Presupuestos"**
   - ‚úÖ Comando de migraci√≥n creado
   - ‚úÖ Documentaci√≥n actualizada

## üìä An√°lisis por M√≥dulo

### **üîë Autenticaci√≥n**
- **Rutas p√∫blicas**: `/login`, `/logout`, `/reset-password`, `/forgot-password`
- **Protecci√≥n**: Sin middleware (acceso p√∫blico)

### **üë• Gesti√≥n de Usuarios**
```php
Route::middleware(['role:Administrador del Sistema|Administrador Municipal'])->group(function () {
    Route::apiResource('users', UserController::class)->middleware('validate.hierarchical.user');
    Route::post('/users/reset-password/{id}', [UserController::class, 'resetPassword']);
});
```
- **Protecci√≥n**: Roles + Validaci√≥n jer√°rquica
- **Permisos requeridos**: Solo administradores

### **üìã Planes de Compra**
```php
// Listar y gestionar planes
Route::middleware(['permission:purchase_plans.list'])->group(function () {
    Route::apiResource('purchase-plans', PurchasePlanController::class);
    Route::get('purchase-plans/year/{year}', [PurchasePlanController::class, 'showByYear']);
    Route::get('purchase-plans/available-directions', [PurchasePlanController::class, 'getAvailableDirections']);
});

// Subir archivos
Route::middleware(['permission:purchase_plans.create'])->group(function () {
    Route::post('purchase-plans/upload/decreto', [PurchasePlanController::class, 'uploadDecreto']);
});

// Aprobar/rechazar planes
Route::middleware(['permission:purchase_plans.approve'])->group(function () {
    Route::put('purchase-plans/status/{id}', [PurchasePlanController::class, 'updateStatus']);
});

// Enviar planes (solo administradores y directores)
Route::middleware(['permission:purchase_plans.send', 'can.send.purchase.plan'])->group(function () {
    Route::post('purchase-plans/{token}/send', [PurchasePlanController::class, 'send']);
});
```
- **Protecci√≥n**: Permisos + Middleware personalizado para env√≠o
- **Permisos**: `list`, `create`, `approve`, `send`
- **Restricci√≥n de env√≠o**: Solo Administrador del Sistema, Administrador Municipal y Director

### **üèóÔ∏è Proyectos**
```php
// Listar y gestionar proyectos
Route::middleware(['permission:projects.list'])->group(function () {
    Route::apiResource('projects', ProjectController::class);
    Route::get('projects/purchase-plan/{purchasePlanId}/index', [ProjectController::class, 'indexByPurchasePlan']);
});

// Verificaci√≥n de proyectos
Route::middleware(['permission:projects.verification'])->group(function () {
    Route::post('projects/verification', [ProjectController::class, 'verification']);
    Route::get('projects/verification/project/{projectId}/index', [ProjectController::class, 'showVerificationProject']);
});
```
- **Protecci√≥n**: Permisos espec√≠ficos por funcionalidad
- **Permisos**: `list`, `verification`

### **üì¶ Items de Compra**
```php
// Listar y gestionar items
Route::middleware(['permission:item_purchases.list'])->group(function () {
    Route::apiResource('item-purchases', ItemPurchaseController::class);
    Route::get('item-purchases/export/{project_id}', [ItemPurchaseController::class, 'export']);
});

// Actualizar estados
Route::middleware(['permission:item_purchases.update_status'])->group(function () {
    Route::put('item-purchases/{id}/status', [ItemPurchaseController::class, 'updateStatus']);
});
```
- **Protecci√≥n**: Permisos separados para gesti√≥n y estados
- **Permisos**: `list`, `update_status`

### **üè¢ Direcciones**
```php
// Solo administradores
Route::middleware(['role:Administrador del Sistema|Administrador Municipal'])->group(function () {
    Route::apiResource('directions', DirectionController::class);
});

// Listar informaci√≥n
Route::middleware(['permission:directions.list'])->group(function () {
    Route::get('directions/{direction}/director', [DirectionController::class, 'getDirector']);
    Route::get('directions/{direction}/users', [DirectionController::class, 'getUsers']);
});

// Editar relaciones
Route::middleware(['permission:directions.edit'])->group(function () {
    Route::post('directions/{direction}/assign-director', [DirectionController::class, 'assignDirector']);
    Route::post('directions/{direction}/assign-users', [DirectionController::class, 'assignUsers'])->middleware('validate.hierarchical.user');
});
```
- **Protecci√≥n**: Roles + Permisos + Validaci√≥n jer√°rquica
- **Permisos**: `list`, `edit`

### **‚öôÔ∏è Configuraci√≥n del Sistema**
```php
// Solo administradores
Route::middleware(['role:Administrador del Sistema|Administrador Municipal'])->group(function () {
    Route::apiResource('status-purchase-plans', StatusPurchasePlanController::class);
    Route::apiResource('directions', DirectionController::class);
});

// Todos los usuarios autenticados
Route::apiResource('type-projects', TypeProjectController::class);
Route::apiResource('unit-purchasings', UnitPurchasingController::class);
Route::apiResource('type-purchases', TypePurchaseController::class);
Route::apiResource('budget-allocations', BudgetAllocationController::class);
Route::apiResource('status-item-purchases', StatusItemPurchaseController::class);
```
- **Protecci√≥n**: Solo autenticaci√≥n (sin restricciones adicionales)
- **Acceso**: Todos los usuarios autenticados

## üõ°Ô∏è Middleware Personalizados

### **1. ValidateHierarchicalUserDirection**

**Prop√≥sito**: Valida reglas de negocio para usuarios jer√°rquicos

**Funcionalidades**:
- ‚úÖ Valida que usuarios jer√°rquicos solo pertenezcan a una direcci√≥n
- ‚úÖ Permite m√∫ltiples direcciones solo a administradores y secretar√≠a comunal
- ‚úÖ Previene asignaciones incorrectas en creaci√≥n/edici√≥n de usuarios

**Rutas protegidas**:
```php
'directions.assign-users',
'directions.assign-director', 
'users.store',
'users.update'
```

**L√≥gica de validaci√≥n**:
```php
// Usuarios jer√°rquicos: Director, Subrogante de Director, Jefatura, Subrogante de Jefatura
// Solo pueden pertenecer a UNA direcci√≥n

// Usuarios multi-direcci√≥n: Administradores, Encargado de Presupuestos
// Pueden pertenecer a M√öLTIPLES direcciones
```

### **2. CheckDirectionPermission**

**Prop√≥sito**: Verifica permisos espec√≠ficos y acceso a direcciones

**Funcionalidades**:
- ‚úÖ Permite todo a administradores del sistema
- ‚úÖ Permite todo a administradores municipales
- ‚úÖ Verifica permisos espec√≠ficos para otros usuarios
- ‚úÖ Valida acceso a direcciones espec√≠ficas

**L√≥gica de validaci√≥n**:
```php
if ($user->hasRole('Administrador del Sistema')) {
    return $next($request); // Acceso total
}

if ($user->hasRole('Administrador Municipal')) {
    return $next($request); // Acceso total
}

if (!$user->can($permission)) {
    return response()->json(['message' => 'No tienes permisos'], 403);
}

// Verificar acceso a direcci√≥n espec√≠fica
if (!$user->directions()->where('direction_id', $directionId)->exists()) {
    return response()->json(['message' => 'No tienes permisos para esta direcci√≥n'], 403);
}
```

### **3. CanSendPurchasePlan**

**Prop√≥sito**: Restringe el env√≠o de planes de compra solo a roles espec√≠ficos

**Funcionalidades**:
- ‚úÖ Solo permite env√≠o a Administrador del Sistema
- ‚úÖ Solo permite env√≠o a Administrador Municipal
- ‚úÖ Solo permite env√≠o a Director
- ‚úÖ Bloquea env√≠o a otros roles (SECPLAN, Jefatura, etc.)

**Rutas protegidas**:
```php
'purchase-plans.send'
```

**L√≥gica de validaci√≥n**:
```php
$allowedRoles = [
    'Administrador del Sistema',
    'Administrador Municipal', 
    'Director'
];

if (!$user->hasAnyRole($allowedRoles)) {
    return response()->json([
        'message' => 'Solo los administradores del sistema, administradores municipales y directores pueden enviar planes de compra para aprobaci√≥n.',
        'user_roles' => $user->getRoleNames()->toArray(),
        'allowed_roles' => $allowedRoles
    ], 403);
}
```

### **4. üéØ Encargado de Presupuestos**
- **Descripci√≥n**: Gesti√≥n de planes de compra municipal
- **Jerarqu√≠a**: Nivel de planificaci√≥n comunal
- **Direcciones**: M√∫ltiples direcciones permitidas
- **Permisos**: Gesti√≥n completa de planes y reportes

### **5. üè¢ Director**
- **Descripci√≥n**: Gesti√≥n de su direcci√≥n espec√≠fica
- **Jerarqu√≠a**: Nivel directivo por direcci√≥n
- **Direcciones**: **UNA SOLA DIRECCI√ìN** (regla jer√°rquica)
- **Permisos**: Gesti√≥n completa de su direcci√≥n

### **6. üîÑ Subrogante de Director**
- **Descripci√≥n**: Funciones del director en ausencia
- **Jerarqu√≠a**: Nivel directivo por direcci√≥n
- **Direcciones**: **UNA SOLA DIRECCI√ìN** (regla jer√°rquica)
- **Permisos**: Mismos que Director

### **7. üìã Jefatura**
- **Descripci√≥n**: Gesti√≥n operativa de proyectos
- **Jerarqu√≠a**: Nivel operativo por direcci√≥n
- **Direcciones**: **UNA SOLA DIRECCI√ìN** (regla jer√°rquica)
- **Permisos**: Gesti√≥n de proyectos e items

### **8. üîÑ Subrogante de Jefatura**
- **Descripci√≥n**: Funciones de jefatura en ausencia
- **Jerarqu√≠a**: Nivel operativo por direcci√≥n
- **Direcciones**: **UNA SOLA DIRECCI√ìN** (regla jer√°rquica)
- **Permisos**: Mismos que Jefatura

### **9. üîÑ Subrogante de Encargado de Presupuestos**
- **Descripci√≥n**: Funciones de Encargado de Presupuestos en ausencia
- **Jerarqu√≠a**: Nivel de planificaci√≥n comunal
- **Direcciones**: M√∫ltiples direcciones permitidas
- **Permisos**: Mismos que Encargado de Presupuestos

## üìà Matriz de Permisos por Rol

| Rol | Planes de Compra | Env√≠o Planes | Proyectos | Items | Direcciones | Configuraci√≥n | Type Projects | Unit Purchasings | Type Purchases | Budget Allocations | Status Items |
|-----|------------------|--------------|-----------|-------|-------------|---------------|---------------|------------------|----------------|-------------------|--------------|
| **Administrador del Sistema** | ‚úÖ Total | ‚úÖ Enviar | ‚úÖ Total | ‚úÖ Total | ‚úÖ Total | ‚úÖ Total | ‚úÖ Total | ‚úÖ Total | ‚úÖ Total | ‚úÖ Total | ‚úÖ Total |
| **Administrador Municipal** | ‚úÖ Total | ‚úÖ Enviar | ‚úÖ Total | ‚úÖ Total | ‚úÖ Total | ‚úÖ Total | ‚úÖ Total | ‚úÖ Total | ‚úÖ Total | ‚úÖ Total | ‚úÖ Total |
| **Director** | üîí Limitado | ‚úÖ Enviar | üîí Limitado | üîí Limitado | üîí Solo su direcci√≥n | ‚ùå Sin acceso | ‚úÖ Total | ‚úÖ Total | ‚úÖ Total | ‚úÖ Total | ‚úÖ Total |
| **Subrogante de Director** | üîí Limitado | ‚ùå Sin env√≠o | üîí Limitado | üîí Limitado | üîí Solo su direcci√≥n | ‚ùå Sin acceso | ‚úÖ Total | ‚úÖ Total | ‚úÖ Total | ‚úÖ Total | ‚úÖ Total |
| **Jefatura** | üîí Limitado | ‚ùå Sin env√≠o | üîí Limitado | üîí Limitado | üîí Solo su direcci√≥n | ‚ùå Sin acceso | ‚úÖ Total | ‚úÖ Total | ‚úÖ Total | ‚úÖ Total | ‚úÖ Total |
| **Subrogante de Jefatura** | üîí Limitado | ‚ùå Sin env√≠o | üîí Limitado | üîí Limitado | üîí Solo su direcci√≥n | ‚ùå Sin acceso | ‚úÖ Total | ‚úÖ Total | ‚úÖ Total | ‚úÖ Total | ‚úÖ Total |
| **Encargado de Presupuestos** | üîí Limitado | ‚ùå Sin env√≠o | üîí Limitado | üîí Limitado | üîí M√∫ltiples direcciones | ‚ùå Sin acceso | ‚úÖ Total | ‚úÖ Total | ‚úÖ Total | ‚úÖ Total | ‚úÖ Total |

## üîç Permisos Granulares

### **Planes de Compra**
- `purchase_plans.list` - Listar planes
- `purchase_plans.create` - Crear planes
- `purchase_plans.edit` - Editar planes
- `purchase_plans.delete` - Eliminar planes
- `purchase_plans.approve` - Aprobar/rechazar planes
- `purchase_plans.send` - Enviar planes
- `purchase_plans.upload_decreto` - Subir decretos

### **Proyectos**
- `projects.list` - Listar proyectos
- `projects.create` - Crear proyectos
- `projects.edit` - Editar proyectos
- `projects.delete` - Eliminar proyectos
- `projects.verification` - Verificar proyectos

### **Items de Compra**
- `item_purchases.list` - Listar items
- `item_purchases.create` - Crear items
- `item_purchases.edit` - Editar items
- `item_purchases.update_status`

### **2. Usuarios Multi-Direcci√≥n**
```php
const MULTI_DIRECTION_ROLES = [
    'Administrador del Sistema',
    'Administrador Municipal',
    'Encargado de Presupuestos',
    'Subrogante de Encargado de Presupuestos'
];
```

**Regla**: Estos usuarios pueden pertenecer a **M√öLTIPLES direcciones**